<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>é€šè²¨ãƒ„ãƒ¼ãƒ«ï¼ˆå¤‰æ›ãƒ»ãƒãƒ£ãƒ¼ãƒˆãƒ»è§£èª¬ çµ±åˆç‰ˆï¼‰</title>
<style>
  :root{
    --accent:#22c55e; --bg:#f6f7f9; --card:#ffffff; --text:#0f172a; --border:#e5e7eb; --radius:14px; --muted:#64748b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{ margin:0; background:var(--bg); color:var(--text);
        font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif; line-height:1.6 }

  /* ===== Header / Tabs ===== */
  header{position:sticky; top:0; z-index:20; background:#fff; border-bottom:1px solid var(--border); backdrop-filter:saturate(1.1) blur(6px)}
  .header-inner{max-width:980px; margin:0 auto; padding:10px 12px; display:flex; align-items:center; gap:12px; justify-content:space-between}
  .title{font-weight:900; white-space:nowrap}
  .seg{ display:inline-flex; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:#fff }
  .seg input{ display:none }
  .seg label{ padding:8px 12px; cursor:pointer; font-size:.95rem; user-select:none; display:flex; align-items:center; gap:8px }
  .seg .icon{ font-size:1.1rem }
  .seg input:checked + label{ background:var(--accent); color:#fff }
  /* ç‹­ã„å¹…ã§ã¯ãƒ†ã‚­ã‚¹ãƒˆã‚’éš ã—ã¦ã‚¢ã‚¤ã‚³ãƒ³ã ã‘ */
  @media (max-width:520px){ .seg label .text{ display:none } }

  .wrap{max-width:980px; margin:0 auto; padding:16px 12px 56px; display:grid; gap:12px}
  .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:14px; box-shadow:0 1px 6px rgba(0,0,0,.04)}
  .label{font-weight:800; font-size:16px; margin-bottom:8px}

  /* Inputs */
  input, select, button{font:inherit; font-size:16px} /* iOSã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã‚ºãƒ¼ãƒ æŠ‘æ­¢ */
  input[type="number"], select{ width:100%; padding:12px; border:1px solid var(--border); border-radius:12px; background:#fff }
  button.primary{background:var(--accent); color:#fff; border:0; padding:14px 16px; border-radius:12px; font-weight:900; width:100%}
  button.ghost{background:#ecfdf5; color:#065f46; border:1px dashed #a7f3d0; border-radius:10px; padding:10px 12px; cursor:pointer}
  .row{display:grid; gap:12px}
  .row-3{grid-template-columns:1fr auto 1fr}

  /* Amount rowï¼šãƒ¢ãƒã‚¤ãƒ«1åˆ—ã€PCã¯ 1fr / 140px */
  .row-amt{grid-template-columns:1fr}
  @media(min-width:700px){ .row-amt{grid-template-columns:1fr 140px} }

  /* Loading bar */
  .loadingbar{height:6px; overflow:hidden; border-radius:3px; background:#e5e7eb; display:none}
  .loadingbar>div{height:100%; width:33%; background:var(--accent); transform:translateX(-100%); animation:slide 1.15s linear infinite}
  @keyframes slide { from{transform:translateX(-100%)} to{transform:translateX(300%)} }

  .swap{display:flex; align-items:center; justify-content:center}
  .swap button{border:0;background:#ecfdf5;color:#065f46;border-radius:10px;padding:10px; cursor:pointer}
  /* ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚ºãƒ¼ãƒ æŠ‘æ­¢ï¼ˆå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã§æœ‰åŠ¹ï¼‰*/
  .seg label, button, .swap button, .menu-btn{ touch-action: manipulation; }
  .muted{ color:var(--muted) }
  .result-jp{font-size:1.35rem; font-weight:900}
  .result-en{color:#4b5563}

  /* ===== Views ===== */
  .view{ display:none }
  /* JSãŒè½ã¡ã¦ã‚‚æœ€ä½é™ã‚³ãƒ³ãƒãƒ¼ãƒˆç”»é¢ã¯è¦‹ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ */
  #view-convert{ display:block }
  /* data-feature ãŒè¨­å®šã•ã‚ŒãŸã‚‰é€šå¸¸ãƒ«ãƒ¼ãƒ«ã«æˆ»ã™ */
  body[data-feature] #view-convert{ display:none }
  body[data-feature="convert"] #view-convert{ display:block }
  body[data-feature="chart"]   #view-chart{ display:block }

  /* ===== Chart specific ===== */
  #chart{ margin-top:12px }
  .invalid{ padding:16px;border:1px dashed #fca5a5;border-radius:12px;background:#fff5f5;color:#b91c1c }
  select:disabled{ background:#f8fafc; color:#94a3b8 }

  /* ===== Layout override menu (â‹¯) ===== */
  .menu-wrap{ position:relative }
  .menu-btn{ border:1px solid var(--border); background:#fff; border-radius:10px; padding:6px 10px; cursor:pointer }
  .menu{ position:absolute; right:0; top:40px; min-width:200px; background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,.08); padding:6px; display:none }
  .menu hr{ border:0; border-top:1px solid var(--border); margin:6px 0 }
  .menu .row{ grid-template-columns:1fr 1fr 1fr }
  .menu .seg{ width:100% }
  .menu.show{ display:block }

  /* Manual layout helpers */
  body.layout-mobile .wrap{max-width:440px}
  body.layout-desktop .wrap{max-width:980px}
  /* Force amount row columns according to manual mode */
  body.layout-mobile .row-amt{grid-template-columns:1fr}
  body.layout-desktop .row-amt{grid-template-columns:1fr 140px}

  /* Chart height tweak for mobile */
  @media (max-width:640px){ #chart{ margin-top:8px } }
  /* === Fullscreen chart overlay === */
  .fs{position:fixed; inset:0; background:#fff; z-index:100; display:flex; flex-direction:column}
  .fs-header{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 12px; border-bottom:1px solid var(--border)}
  .fs-body{flex:1; min-height:0}
  #fs-chart{ width:100%; height:100%; }
</style>

<header>
  <div class="header-inner">
    <div class="title">ğŸ’± é€šè²¨ãƒ„ãƒ¼ãƒ«</div>

    <!-- æ©Ÿèƒ½åˆ‡æ›¿ï¼šå¤‰æ› / ãƒãƒ£ãƒ¼ãƒˆï¼ˆâ€»è§£èª¬ã¯å„ãƒšãƒ¼ã‚¸ä¸‹éƒ¨ã«çµ±åˆï¼‰ -->
    <div class="seg" id="featureSeg" role="tablist" aria-label="æ©Ÿèƒ½åˆ‡æ›¿">
      <input type="radio" name="feature" id="f-convert" value="convert" checked>
      <label for="f-convert"><span class="icon">ğŸ”</span><span class="text">å¤‰æ›</span></label>
      <input type="radio" name="feature" id="f-chart" value="chart">
      <label for="f-chart"><span class="icon">ğŸ“ˆ</span><span class="text">ãƒãƒ£ãƒ¼ãƒˆ</span></label>
    </div>

    <!-- å³ä¸Šãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãªã©ï¼‰ -->
    <div class="menu-wrap">
      <button class="menu-btn" id="btnMenu" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">â‹¯</button>
      <div class="menu" id="menu">
        <div class="label" style="margin:6px">è¡¨ç¤ºåˆ‡æ›¿</div>
        <div class="seg" id="modeSeg" style="margin:6px">
          <input type="radio" name="mode" id="m-auto" value="auto" checked><label for="m-auto">Auto</label>
          <input type="radio" name="mode" id="m-desktop" value="desktop"><label for="m-desktop">PC</label>
          <input type="radio" name="mode" id="m-mobile" value="mobile"><label for="m-mobile">ãƒ¢ãƒã‚¤ãƒ«</label>
        </div>
        <hr>
        <div class="muted" style="padding:6px 8px; font-size:.9rem">â€» è¨­å®šã¯ç«¯æœ«å†…ã«ä¿å­˜ã•ã‚Œã¾ã™</div>
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <!-- ===== Convert View ===== -->
  <section id="view-convert" class="view">
    <div id="loading" class="loadingbar"><div></div></div>

    <section class="card">
      <div class="label">é‡‘é¡ã¨å˜ä½</div>
      <div class="row row-amt">
        <input id="amount" type="number" inputmode="decimal" placeholder="é‡‘é¡ï¼ˆä¾‹: 100ï¼‰">
        <select id="unit" aria-label="å˜ä½">
          <option value="">ï¼ˆãªã—ï¼‰</option>
          <option>ä¸‡</option><option>å„„</option><option>å…†</option>
          <option>K</option><option>M</option><option>B</option><option>T</option>
        </select>
      </div>
    </section>

    <section class="card">
      <div class="label">é€šè²¨ã‚’é¸æŠ</div>
      <div class="row row-3">
        <select id="from" aria-label="å¤‰æ›å…ƒ">
          <option>USD</option><option>JPY</option><option>EUR</option><option>GBP</option>
          <option>CAD</option><option>HKD</option><option>CNY</option><option>KRW</option>
        </select>
        <div class="swap"><button id="swap" title="å…¥ã‚Œæ›¿ãˆ">â†”ï¸</button></div>
        <select id="to" aria-label="å¤‰æ›å…ˆ">
          <option>JPY</option><option>USD</option><option>EUR</option><option>GBP</option>
          <option>CAD</option><option>HKD</option><option>CNY</option><option>KRW</option>
        </select>
      </div>
    </section>

    <section class="card">
      <div class="row" style="grid-template-columns:auto auto; align-items:center">
        <div class="label" style="margin:0">ãƒ¬ãƒ¼ãƒˆ</div>
        <button id="refresh" class="ghost" style="justify-self:end">âŸ³ æ›´æ–°</button>
      </div>
      <div id="rateText" style="font-weight:700">æœªå–å¾—</div>
      <div id="rateTime" class="muted"></div>
    </section>

    <section class="card">
      <button id="convert" class="primary">å¤‰æ›</button>
      <div style="margin-top:12px">
        <div id="resJP" class="result-jp">çµæœ: -</div>
        <div id="resEN" class="result-en"></div>
      </div>
    </section>

    <!-- â–¼ è§£èª¬ï¼ˆåŒãƒšãƒ¼ã‚¸ä¸‹éƒ¨ï¼‰ -->
    <section class="card">
      <div class="label">é€šè²¨ã‚³ãƒ¼ãƒ‰è§£èª¬</div>
      <div id="list-convert" class="row" style="grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:10px"></div>
    </section>
  </section>

  <!-- ===== Chart View ===== -->
  <section id="view-chart" class="view">
    <section class="card">
      <div class="row" style="grid-template-columns:auto 1fr auto; align-items:center">
        <div class="label" style="margin:0">é€šè²¨ãƒšã‚¢ï¼ˆãƒãƒ£ãƒ¼ãƒˆï¼‰</div>
        <!-- æ™‚é–“è»¸: æ—¥è¶³ / é€±è¶³ / æœˆè¶³ -->
        <div class="seg" id="intervalSeg" role="tablist" aria-label="æ™‚é–“è»¸">
          <input type="radio" name="tf" id="tf-D" value="D" checked>
          <label for="tf-D">æ—¥è¶³</label>
          <input type="radio" name="tf" id="tf-W" value="W">
          <label for="tf-W">é€±è¶³</label>
          <input type="radio" name="tf" id="tf-M" value="M">
          <label for="tf-M">æœˆè¶³</label>
        </div>
        <button id="btnFull" class="ghost" style="justify-self:end">â¤¢ å…¨ç”»é¢</button>
      </div>
      <div class="row row-3" style="margin-top:4px">
        <select id="base" aria-label="åŸºè»¸é€šè²¨"></select>
        <div class="swap"><button id="btnSwap" title="å…¥ã‚Œæ›¿ãˆ">â†”ï¸</button></div>
        <select id="quote" aria-label="æ±ºæ¸ˆé€šè²¨"></select>
      </div>
      <div id="chart" aria-live="polite"></div>
      <div id="hint" class="muted" style="margin-top:6px"></div>
    </section>

    <!-- â–¼ è§£èª¬ï¼ˆåŒãƒšãƒ¼ã‚¸ä¸‹éƒ¨ï¼‰ -->
    <section class="card">
      <div class="label">é€šè²¨ã‚³ãƒ¼ãƒ‰è§£èª¬</div>
      <div id="list-chart" class="row" style="grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:10px"></div>
    </section>
  </section>
</div>

<!-- TradingView -->
<script src="https://s3.tradingview.com/tv.js"></script>
<script>
  // ====== Config / Shared ======
  const currencies = [
    {code:"USD", flag:"ğŸ‡ºğŸ‡¸", country:"ã‚¢ãƒ¡ãƒªã‚«",     name:"ç±³ãƒ‰ãƒ«"},
    {code:"JPY", flag:"ğŸ‡¯ğŸ‡µ", country:"æ—¥æœ¬",         name:"æ—¥æœ¬å††"},
    {code:"EUR", flag:"ğŸ‡ªğŸ‡º", country:"æ¬§å·é€£åˆ",     name:"ãƒ¦ãƒ¼ãƒ­"},
    {code:"GBP", flag:"ğŸ‡¬ğŸ‡§", country:"ã‚¤ã‚®ãƒªã‚¹",     name:"è‹±ãƒãƒ³ãƒ‰"},
    {code:"AUD", flag:"ğŸ‡¦ğŸ‡º", country:"ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢", name:"è±ªãƒ‰ãƒ«"},
    {code:"CAD", flag:"ğŸ‡¨ğŸ‡¦", country:"ã‚«ãƒŠãƒ€",       name:"ã‚«ãƒŠãƒ€ãƒ‰ãƒ«"},
    {code:"CHF", flag:"ğŸ‡¨ğŸ‡­", country:"ã‚¹ã‚¤ã‚¹",       name:"ã‚¹ã‚¤ã‚¹ãƒ•ãƒ©ãƒ³"},
    {code:"HKD", flag:"ğŸ‡­ğŸ‡°", country:"é¦™æ¸¯",         name:"é¦™æ¸¯ãƒ‰ãƒ«"},
    {code:"CNY", flag:"ğŸ‡¨ğŸ‡³", country:"ä¸­å›½",         name:"äººæ°‘å…ƒ"},
    {code:"KRW", flag:"ğŸ‡°ğŸ‡·", country:"éŸ“å›½",         name:"éŸ“å›½ã‚¦ã‚©ãƒ³"},
    {code:"BTC", flag:"â‚¿",   country:"æš—å·è³‡ç”£",     name:"ãƒ“ãƒƒãƒˆã‚³ã‚¤ãƒ³"},
    {code:"XAU", flag:"ğŸ¥‡",   country:"è²´é‡‘å±",       name:"ã‚´ãƒ¼ãƒ«ãƒ‰ï¼ˆé‡‘ï¼‰"}
  ];

  // Persist helpers
  const store = {
    get(k, def){ try{ const v = localStorage.getItem(k); return v==null?def:JSON.parse(v) }catch{ return def } },
    set(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)) }catch{} }
  };

  /* ====== Viewport scaling toggle (Chartæ™‚ã®ã¿ãƒšãƒ¼ã‚¸æ‹¡å¤§ã‚’æŠ‘æ­¢) ====== */
  const viewportMeta = document.querySelector('meta[name="viewport"]');
  const originalViewport = viewportMeta?.getAttribute('content') || 'width=device-width, initial-scale=1';
  function setViewportScaling(disable){
    if (!viewportMeta) return;
    if (disable){
      const base = originalViewport.split(',').filter(s=>!(/maximum-scale|user-scalable/i).test(s)).join(',').trim();
      viewportMeta.setAttribute('content', base + ', maximum-scale=1, user-scalable=no');
    } else {
      viewportMeta.setAttribute('content', originalViewport);
    }
  }
  window.addEventListener('pageshow', ()=>{ if(document.body.dataset?.feature==='chart') setViewportScaling(true); });
  window.addEventListener('beforeunload', ()=> setViewportScaling(false));

  // ====== Header: feature tabs & menu ======
  function setFeature(f){
    document.body.dataset.feature = f;
    // ãƒãƒ£ãƒ¼ãƒˆæ™‚ã®ã¿ãƒšãƒ¼ã‚¸æ‹¡å¤§ï¼ˆãƒ”ãƒ³ãƒ/ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ï¼‰ã‚’æŠ‘æ­¢
    setViewportScaling(f==='chart');
    // ãƒãƒ£ãƒ¼ãƒˆä»¥å¤–ã«ç§»å‹•ã—ãŸã‚‰ã€å…¨ç”»é¢è¡¨ç¤ºä¸­ãªã‚‰é–‰ã˜ã‚‹
    if (f !== 'chart' && window.__closeFS) { try{ window.__closeFS(); }catch(e){} }
    if (f==='chart') ensureChartRendered();
  }

  // èµ·å‹•æ™‚ã¯å¸¸ã«ã€Œå¤‰æ›ã€ã‹ã‚‰é–‹å§‹ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›ï¼‰
  document.getElementById('f-convert').setAttribute('checked','checked');
  setFeature('convert');

  document.getElementById('featureSeg').addEventListener('change', ()=>{
    const f = document.querySelector('#featureSeg input:checked')?.value || 'convert';
    setFeature(f);
  });

  // Menu
  const $menuBtn = document.getElementById('btnMenu');
  const $menu    = document.getElementById('menu');
  $menuBtn.addEventListener('click', ()=>{ $menu.classList.toggle('show') });
  document.addEventListener('click', (e)=>{ if(!e.target.closest('.menu-wrap')) $menu.classList.remove('show') });

  // Manual layout mode (visual width hints only)
  const modeSaved = store.get('layoutMode','auto');
  applyMode(modeSaved);
  const modeSeg = document.getElementById('modeSeg');
  modeSeg.querySelector(`#m-${modeSaved}`)?.setAttribute('checked','checked');
  modeSeg.addEventListener('change', ()=>{
    const m = modeSeg.querySelector('input:checked')?.value || 'auto';
    applyMode(m); store.set('layoutMode', m);
  });
  function applyMode(mode){
    document.body.classList.remove('layout-mobile','layout-desktop');
    if (mode==='mobile') document.body.classList.add('layout-mobile');
    if (mode==='desktop') document.body.classList.add('layout-desktop');
    // Re-render chart to adapt widget height/layout after mode change
    if (document.body.dataset.feature === 'chart') { try{ renderChart(); }catch(e){} }
    // Close menu after selection (helps on mobile)
    try{ $menu.classList.remove('show'); }catch(e){}
  }

  // ====== Convert view ======
  const API_KEY = "b83959fae8ef48f560972001"; // å®Ÿé¨“ç”¨ï¼ˆå…¬é–‹é…å¸ƒã¯éæ¨å¥¨ï¼‰
  const unitsMap = {"":1,"ä¸‡":1e4,"å„„":1e8,"å…†":1e12,"K":1e3,"M":1e6,"B":1e9,"T":1e12};

  const $amount = document.getElementById('amount');
  const $unit   = document.getElementById('unit');
  const $from   = document.getElementById('from');
  const $to     = document.getElementById('to');
  const $swap   = document.getElementById('swap');
  const $refresh= document.getElementById('refresh');
  const $rateText = document.getElementById('rateText');
  const $rateTime = document.getElementById('rateTime');
  const $convert  = document.getElementById('convert');
  const $loading  = document.getElementById('loading');

  function rateKey(){ return `rate_${$from.value}_${$to.value}` }
  function dateKey(){ return `rateAt_${$from.value}_${$to.value}` }

  function saveRate(rate){
    localStorage.setItem(rateKey(), String(rate));
    const stamp = new Date().toLocaleString('ja-JP', {year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'});
    localStorage.setItem(dateKey(), stamp);
    paintSaved();
  }
  function loadRate(){ const r = parseFloat(localStorage.getItem(rateKey()) || "NaN"); return Number.isFinite(r) ? r : null }
  function paintSaved(){
    const r = loadRate(); const t = localStorage.getItem(dateKey()) || "";
    if (r!=null){ $rateText.textContent = `1 ${$from.value} = ${r.toFixed(4)} ${$to.value}`; $rateTime.textContent = t; }
    else { $rateText.textContent = "æœªå–å¾—"; $rateTime.textContent = ""; }
  }

  function parseAmount(){ const base = parseFloat(($amount.value||"").trim()); if (!Number.isFinite(base)) return null; return base * (unitsMap[$unit.value] || 1); }

  async function fetchRate(){
    const from = $from.value, to = $to.value;
    try{
      $loading.style.display = "block";
      const url = `https://v6.exchangerate-api.com/v6/${encodeURIComponent(API_KEY)}/pair/${from}/${to}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const j = await res.json();
      if (j.result!=="success") throw new Error(`API error: ${j.result||"unknown"}`);
      saveRate(j.conversion_rate);
    } catch(e){ alert(`ãƒ¬ãƒ¼ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼: ${e.message||e}`); }
    finally{ $loading.style.display = "none"; paintSaved(); }
  }

  function formatJP(num){ const abs=Math.abs(num), sign=num<0?"-":""; if(abs>=1e12) return `${sign}${(abs/1e12).toFixed(2)}å…†`; if(abs>=1e8) return `${sign}${(abs/1e8).toFixed(2)}å„„`; if(abs>=1e4) return `${sign}${(abs/1e4).toFixed(2)}ä¸‡`; return `${sign}${abs.toFixed(2)}` }
  function formatEN(num){ const abs=Math.abs(num), sign=num<0?"-":""; if(abs>=1e12) return `${sign}${(abs/1e12).toFixed(2)}T`; if(abs>=1e9) return `${sign}${(abs/1e9).toFixed(2)}B`; if(abs>=1e6) return `${sign}${(abs/1e6).toFixed(2)}M`; if(abs>=1e3) return `${sign}${(abs/1e3).toFixed(2)}K`; return `${sign}${abs.toFixed(2)}` }

  function convert(){
    const amt = parseAmount(); if (amt==null){ alert("é‡‘é¡ã‚’å…¥åŠ›"); return; }
    const rate = loadRate(); if (rate==null){ alert("ãƒ¬ãƒ¼ãƒˆæœªå–å¾—ã€‚ã€æ›´æ–°ã€ã—ã¦ãã ã•ã„"); return; }
    const converted = amt * rate;
    document.getElementById('resJP').textContent = "çµæœ: " + formatJP(converted);
    document.getElementById('resEN').textContent = ($unit.value ? formatEN(converted) : "");
  }

  $refresh.addEventListener('click', fetchRate);
  $convert.addEventListener('click', convert);
  $swap.addEventListener('click', ()=>{
    const a = $from.value; $from.value = $to.value; $to.value = a;
    localStorage.removeItem(rateKey()); localStorage.removeItem(dateKey());
    $rateText.textContent = "æœªå–å¾—"; $rateTime.textContent = ""; fetchRate();
  });

  paintSaved();

  // ====== Chart view ======
  const $base  = document.getElementById('base');
  const $quote = document.getElementById('quote');
  const tvContainer = document.getElementById('chart');
  const $hint = document.getElementById('hint');

  // æ™‚é–“è»¸ï¼ˆD/W/Mï¼‰
  const intervalSeg = document.getElementById('intervalSeg');
  let currentInterval = store.get('cinterval','D');
  intervalSeg.querySelector(`#tf-${currentInterval}`)?.setAttribute('checked','checked');
  intervalSeg.addEventListener('change', ()=>{
    currentInterval = intervalSeg.querySelector('input:checked')?.value || 'D';
    store.set('cinterval', currentInterval);
    if (document.body.dataset.feature==='chart') renderChart();
  });

  // iPhoneæ¨ªç”»é¢ã®ãƒªã‚µã‚¤ã‚ºå¤šç™ºå¯¾ç­–ï¼ˆå¹…å¤‰åŒ–ã®ã¿ã§å†æç”»ï¼†ãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼‰
  let lastW = window.innerWidth; let resizeTimer = null;
  function scheduleChartRerenderOnResize(){
    if (document.body.dataset.feature !== 'chart') return;
    const w = window.innerWidth;
    if (Math.abs(w - lastW) < 40) return; // URLãƒãƒ¼ã®å‡ºå…¥ã‚Šãªã©é«˜ã•å¤‰åŒ–ã¯ç„¡è¦–
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(()=>{ lastW = w; renderChart(); }, 220);
  }
  window.addEventListener('resize', scheduleChartRerenderOnResize);
  window.addEventListener('orientationchange', ()=>{ setTimeout(()=>{ lastW = window.innerWidth; if (document.body.dataset.feature==='chart') renderChart(); }, 350); });

  // ===== å…¨ç”»é¢ãƒãƒ£ãƒ¼ãƒˆ =====
  let fsNode = null; let onOrientFS = null;
  function openFullscreenChart(){
    if (fsNode) return;
    fsNode = document.createElement('div'); fsNode.className='fs';
    fsNode.innerHTML = '<div class="fs-header"><div>ğŸ“ˆ ãƒãƒ£ãƒ¼ãƒˆï¼ˆå…¨ç”»é¢ï¼‰</div><button id="fsClose" class="ghost">é–‰ã˜ã‚‹ âœ•</button></div><div class="fs-body"><div id="fs-chart"></div></div>';
    document.body.appendChild(fsNode);
    const sym = currentSymbol($base.value, $quote.value);
    function renderFS(){ const h = Math.floor(window.visualViewport? window.visualViewport.height: window.innerHeight); const el = document.getElementById('fs-chart'); if(!el) return; el.innerHTML=''; new TradingView.widget({ container_id:'fs-chart', symbol:sym, interval: currentInterval, width:'100%', height:h, locale:'ja', theme:'light', disabled_features:['header_interval_dialog_button'] }); }
    renderFS();
    onOrientFS = ()=>{ setTimeout(renderFS, 350); };
    window.addEventListener('orientationchange', onOrientFS);

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«é–‰ã˜ã‚‹é–¢æ•°ã‚’æä¾›ï¼ˆä»–ãƒ“ãƒ¥ãƒ¼ã¸åˆ‡æ›¿æ™‚ã«å‘¼ã¶ï¼‰
    window.__closeFS = function(){
      window.removeEventListener('orientationchange', onOrientFS);
      if (fsNode){ fsNode.remove(); fsNode=null; }
      window.__closeFS = null;
    };
    document.getElementById('fsClose').addEventListener('click', ()=>{ if (window.__closeFS) window.__closeFS(); });
  }
  const $btnFull = document.getElementById('btnFull'); if ($btnFull) $btnFull.addEventListener('click', openFullscreenChart);

  // ã‚»ãƒ¬ã‚¯ãƒˆåˆæœŸåŒ–ï¼ˆãƒãƒ£ãƒ¼ãƒˆç”¨ï¼‰
  currencies.forEach(c => { $base.append(new Option(c.code, c.code)); $quote.append(new Option(c.code, c.code)); });
  const savedPair = store.get('cprefs', {base:'USD', quote:'JPY'});
  $base.value  = savedPair.base  || 'USD';
  $quote.value = savedPair.quote || 'JPY';

  function showInvalid(msg){ tvContainer.innerHTML = `<div class="invalid">ãƒãƒ£ãƒ¼ãƒˆç„¡åŠ¹ï¼š${msg}</div>`; }
  const isBTC = (x)=> x==='BTC';
  const isXAU = (x)=> x==='XAU';
  function allowedQuotesForSpecial(base){ if (isBTC(base) || isXAU(base)) return ['JPY','USD']; return null }

  function updateOptionConstraints(){
    const base = $base.value, quote = $quote.value;
    [...$base.options].forEach(o=>o.disabled=false);
    [...$quote.options].forEach(o=>o.disabled=false);

    const qAllow = allowedQuotesForSpecial(base);
    if (qAllow){
      [...$quote.options].forEach(o=>{ o.disabled = !qAllow.includes(o.value); });
      if ($quote.options[$quote.selectedIndex].disabled){ $quote.value = qAllow.includes('JPY') ? 'JPY' : 'USD'; }
    }
    const bAllow = allowedQuotesForSpecial(quote);
    if (bAllow){
      [...$base.options].forEach(o=>{ o.disabled = !bAllow.includes(o.value); });
      if ($base.options[$base.selectedIndex].disabled){ $base.value = bAllow.includes('JPY') ? 'JPY' : 'USD'; }
    }
  }

  function currentSymbol(base, quote){
    if (base === quote) return null;
    if ((base==='BTC' && quote==='JPY') || (base==='JPY' && quote==='BTC')) return 'BITFLYER:BTCJPY';
    if ((base==='BTC' && quote==='USD') || (base==='USD' && quote==='BTC')) return 'BINANCE:BTCUSDT';
    if ((base==='XAU' && quote==='JPY') || (base==='JPY' && quote==='XAU')) return 'OANDA:XAUJPY';
    if ((base==='XAU' && quote==='USD') || (base==='USD' && quote==='XAU')) return 'TVC:GOLD'; // ä»£æ›¿: OANDA:XAUUSD
    if (base!=='BTC' && quote!=='BTC' && base!=='XAU' && quote!=='XAU') return `FX_IDC:${base}${quote}`;
    return null;
  }

  let chartRendered = false;
  function ensureChartRendered(){ if (!chartRendered){ renderChart(); chartRendered = true; } }

  function chartHeight(){ return (document.body.classList.contains('layout-desktop') ? 440 : (window.innerWidth < 640 ? 380 : 440)); }

  function renderChart(){
    const base = $base.value, quote = $quote.value; updateOptionConstraints();
    const sym = currentSymbol(base, quote);
    if (!sym){ showInvalid(base===quote? 'åŒã˜é€šè²¨ãƒšã‚¢ã¯é¸ã¹ã¾ã›ã‚“' : 'ã“ã®é€šè²¨ãƒšã‚¢ã¯å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“'); $hint.textContent=''; return; }
    tvContainer.innerHTML = '';
    new TradingView.widget({
      container_id:'chart', symbol:sym, interval: currentInterval, width:'100%', height: chartHeight(), locale:'ja', theme:'light',
      disabled_features:['header_interval_dialog_button']
    });
    if (base==='XAU' || quote==='XAU'){ $hint.textContent = 'XAU ã¯é‡‘ã®ãƒˆãƒ­ã‚¤ã‚ªãƒ³ã‚¹å»ºã¦ï¼ˆJPY ã¯å††/ã‚ªãƒ³ã‚¹ã€USD ã¯ãƒ‰ãƒ«/ã‚ªãƒ³ã‚¹ï¼‰'; } else { $hint.textContent=''; }
    store.set('cprefs', { base, quote });
  }

  $base.addEventListener('change', ()=>{ renderChart() });
  $quote.addEventListener('change', ()=>{ renderChart() });
  document.getElementById('btnSwap').addEventListener('click', ()=>{ const t=$base.value; $base.value=$quote.value; $quote.value=t; renderChart(); });

  // åˆæœŸè¡¨ç¤ºï¼ˆå¿…è¦ãªã¨ãã ã‘ï¼‰
  if (document.body.dataset.feature==='chart') ensureChartRendered();

  // ===== Glossary (å„ãƒšãƒ¼ã‚¸ä¸‹éƒ¨ã¸æç”») =====
  function renderGlossaryInto(id){
    const el = document.getElementById(id); if(!el) return;
    el.innerHTML = currencies.map(c => `
      <div class="card" style="display:flex; gap:10px; align-items:center">
        <span style="font-size:22px">${c.flag}</span>
        <b style="width:56px">${c.code}</b>
        <div>
          <div>${c.country}</div>
          <div class="muted">${c.name}</div>
        </div>
      </div>
    `).join("");
  }
  renderGlossaryInto('list-convert');
  renderGlossaryInto('list-chart');
</script>
</html>
