<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>é€šè²¨ãƒ„ãƒ¼ãƒ«ï¼šå¤‰æ› & ãƒãƒ£ãƒ¼ãƒˆ</title>
<style>
  :root{
    --bg:#f6f7f9; --card:#fff; --text:#0f172a; --border:#e5e7eb; --accent:#22c55e; --muted:#64748b;
  }
  *{box-sizing:border-box}
  body{margin:0; background:var(--bg); color:var(--text);
       font-family:system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",sans-serif; line-height:1.65}
  .app{display:grid; grid-template-columns:220px 1fr; min-height:100dvh}
  @media(max-width:760px){ .app{grid-template-columns:1fr} .sidebar{position:sticky; top:0; z-index:10} }
  .sidebar{background:#fff;border-right:1px solid var(--border)}
  .side-inner{max-height:100dvh;overflow:auto;padding:14px}
  .brand{font-weight:900; padding:6px 8px; border-radius:10px; display:inline-block}
  .nav{display:grid; gap:8px; margin-top:12px}
  .tab{display:flex; align-items:center; gap:10px; padding:10px 12px; border:1px solid var(--border); border-radius:12px;
       background:#fff; cursor:pointer; font-weight:800}
  .tab.active{border-color:var(--accent); outline:2px solid color-mix(in srgb, var(--accent) 35%, transparent)}
  .content{padding:18px}
  .wrap{max-width:980px; margin:0 auto; display:grid; gap:16px}
  .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 1px 6px rgba(0,0,0,.04)}
  h2{font-size:1.1rem; margin:0 0 10px}
  input,select,button{font:inherit}
  input[type="number"],select{
    width:100%; padding:12px; border:1px solid var(--border); border-radius:12px; background:#fff
  }
  .row{display:grid; gap:12px}
  .row-2{grid-template-columns:1fr}
  .row-3{grid-template-columns:1fr auto 1fr}
  @media(min-width:700px){ .row-2{grid-template-columns:1fr 140px} }
  .btn{border:0; padding:12px 14px; border-radius:12px; cursor:pointer}
  .btn-primary{background:var(--accent); color:#fff; font-weight:900}
  .btn-ghost{background:#ecfdf5; color:#065f46}
  .swap{display:flex; align-items:center; justify-content:center}
  .swap button{border:0;background:#ecfdf5;color:#065f46;border-radius:10px;padding:10px 12px; cursor:pointer}
  .loadingbar{height:6px; overflow:hidden; border-radius:3px; background:#e5e7eb; display:none}
  .loadingbar>div{height:100%; width:33%; background:var(--accent); transform:translateX(-100%); animation:slide 1.1s linear infinite}
  @keyframes slide{from{transform:translateX(-100%)} to{transform:translateX(300%)}}
  .result-jp{font-size:1.35rem; font-weight:900}
  .result-en{color:#4b5563}
  .grid-list{display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:10px}
  .item{display:flex; gap:10px; align-items:center; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:#fff}
  .flag{font-size:22px}
  .code{font-weight:800; width:56px}
  .muted{color:var(--muted)}
</style>

<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="side-inner">
      <div class="brand">ğŸ’± é€šè²¨ãƒ„ãƒ¼ãƒ«</div>
      <div class="nav">
        <button class="tab active" data-tab="convert">ğŸ”„ é€šè²¨å¤‰æ›</button>
        <button class="tab" data-tab="chart">ğŸ“ˆ ãƒãƒ£ãƒ¼ãƒˆ</button>
      </div>
    </div>
  </aside>

  <!-- Main content -->
  <main class="content">
    <div class="wrap">
      <!-- é€šè²¨å¤‰æ› -->
      <section id="convert" class="card">
        <h2>ğŸ”„ é€šè²¨å¤‰æ›</h2>
        <div id="loading" class="loadingbar"><div></div></div>
        <div class="row row-2" style="margin-bottom:12px">
          <input id="amount" type="number" inputmode="decimal" placeholder="é‡‘é¡">
          <select id="unit">
            <option value="">ï¼ˆãªã—ï¼‰</option>
            <option>ä¸‡</option><option>å„„</option><option>å…†</option>
            <option>K</option><option>M</option><option>B</option><option>T</option>
          </select>
        </div>
        <div class="row row-3" style="margin-bottom:12px">
          <select id="from">
            <option>USD</option><option>JPY</option><option>EUR</option><option>GBP</option>
            <option>CAD</option><option>HKD</option><option>CNY</option><option>KRW</option>
          </select>
          <div class="swap"><button id="swap">â†”ï¸</button></div>
          <select id="to">
            <option>JPY</option><option>USD</option><option>EUR</option><option>GBP</option>
            <option>CAD</option><option>HKD</option><option>CNY</option><option>KRW</option>
          </select>
        </div>
        <div class="row" style="grid-template-columns:auto auto; align-items:center; margin-bottom:10px">
          <div id="rateText" style="font-weight:700">æœªå–å¾—</div>
          <button id="refresh" class="btn btn-ghost" style="justify-self:end">âŸ³ æ›´æ–°</button>
        </div>
        <div id="rateTime" class="muted" style="margin-bottom:10px"></div>
        <button id="convertBtn" class="btn btn-primary">å¤‰æ›</button>
        <div style="margin-top:12px">
          <div id="resJP" class="result-jp">çµæœ: -</div>
          <div id="resEN" class="result-en"></div>
        </div>
      </section>

      <!-- ãƒãƒ£ãƒ¼ãƒˆ -->
      <section id="chart" class="card" style="display:none">
        <h2>ğŸ“ˆ ãƒãƒ£ãƒ¼ãƒˆ</h2>
        <div class="row row-3">
          <select id="base"></select>
          <div class="swap"><button id="btnSwap">â†”ï¸</button></div>
          <select id="quote"></select>
        </div>
        <div id="tvchart" style="margin-top:16px"></div>
      </section>

      <!-- é€šè²¨ã‚³ãƒ¼ãƒ‰ä¸€è¦§ï¼ˆå…±é€šï¼‰ -->
      <section class="card">
        <h2>â„¹ï¸ é€šè²¨ã‚³ãƒ¼ãƒ‰</h2>
        <div id="codeList" class="grid-list"></div>
      </section>
    </div>
  </main>
</div>

<!-- TradingView -->
<script src="https://s3.tradingview.com/tv.js"></script>
<script>
  /* ========= å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ‡æ›¿ ========= */
  const tabs = document.querySelectorAll('.tab');
  const views = { convert: document.getElementById('convert'), chart: document.getElementById('chart') };
  tabs.forEach(b=>{
    b.addEventListener('click', ()=>{
      tabs.forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      const key = b.dataset.tab;
      for (const k in views) views[k].style.display = (k===key)?'block':'none';
    });
  });

  /* ========= é€šè²¨å¤‰æ› ========= */
  const API_KEY = "b83959fae8ef48f560972001"; // å®Ÿé¨“ç”¨ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
  const unitsMap = {"":1,"ä¸‡":1e4,"å„„":1e8,"å…†":1e12,"K":1e3,"M":1e6,"B":1e9,"T":1e12};

  const $amount = document.getElementById('amount');
  const $unit   = document.getElementById('unit');
  const $from   = document.getElementById('from');
  const $to     = document.getElementById('to');
  const $swap   = document.getElementById('swap');
  const $refresh= document.getElementById('refresh');
  const $rateText = document.getElementById('rateText');
  const $rateTime = document.getElementById('rateTime');
  const $convertBtn = document.getElementById('convertBtn');
  const $loading  = document.getElementById('loading');

  function rateKey(){ return `rate_${$from.value}_${$to.value}` }
  function dateKey(){ return `rateAt_${$from.value}_${$to.value}` }

  function saveRate(rate){
    localStorage.setItem(rateKey(), String(rate));
    localStorage.setItem(dateKey(), new Date().toLocaleString('ja-JP',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'}));
    paintSaved();
  }
  function loadRate(){
    const r = parseFloat(localStorage.getItem(rateKey()) || "NaN");
    return Number.isFinite(r) ? r : null;
  }
  function paintSaved(){
    const r = loadRate();
    const t = localStorage.getItem(dateKey()) || "";
    if (r!=null){ $rateText.textContent = `1 ${$from.value} = ${r.toFixed(4)} ${$to.value}`; $rateTime.textContent = t; }
    else { $rateText.textContent = "æœªå–å¾—"; $rateTime.textContent = ""; }
  }
  function parseAmount(){
    const base = parseFloat(($amount.value||"").trim());
    if (!Number.isFinite(base)) return null;
    return base * (unitsMap[$unit.value] || 1);
  }
  async function fetchRate(){
    const from = $from.value, to = $to.value;
    try{
      $loading.style.display = "block";
      const url = `https://v6.exchangerate-api.com/v6/${encodeURIComponent(API_KEY)}/pair/${from}/${to}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const j = await res.json();
      if (j.result!=="success") throw new Error(`API error: ${j.result||"unknown"}`);
      saveRate(j.conversion_rate);
    }catch(e){ alert(`ãƒ¬ãƒ¼ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼: ${e.message||e}`)}
    finally{ $loading.style.display = "none"; paintSaved(); }
  }
  function formatJP(num){
    const abs = Math.abs(num), s = num<0?"-":"";
    if (abs>=1e12) return `${s}${(abs/1e12).toFixed(2)}å…†`;
    if (abs>=1e8)  return `${s}${(abs/1e8).toFixed(2)}å„„`;
    if (abs>=1e4)  return `${s}${(abs/1e4).toFixed(2)}ä¸‡`;
    return `${s}${abs.toFixed(2)}`;
  }
  function formatEN(num){
    const a=Math.abs(num), s=num<0?"-":"";
    if(a>=1e12) return `${s}${(a/1e12).toFixed(2)}T`;
    if(a>=1e9)  return `${s}${(a/1e9).toFixed(2)}B`;
    if(a>=1e6)  return `${s}${(a/1e6).toFixed(2)}M`;
    if(a>=1e3)  return `${s}${(a/1e3).toFixed(2)}K`;
    return `${s}${a.toFixed(2)}`;
  }
  function convert(){
    const amt = parseAmount(); if (amt==null) { alert("é‡‘é¡ã‚’å…¥åŠ›"); return; }
    const rate = loadRate();   if (rate==null){ alert("ãƒ¬ãƒ¼ãƒˆæœªå–å¾—ã€‚ã€æ›´æ–°ã€ã—ã¦ãã ã•ã„"); return; }
    const v = amt * rate;
    document.getElementById('resJP').textContent = "çµæœ: " + formatJP(v);
    document.getElementById('resEN').textContent = ($unit.value ? formatEN(v) : "");
  }
  $refresh.addEventListener('click', fetchRate);
  $convertBtn.addEventListener('click', convert);
  $swap.addEventListener('click', ()=>{
    const a=$from.value; $from.value=$to.value; $to.value=a;
    localStorage.removeItem(rateKey()); localStorage.removeItem(dateKey());
    $rateText.textContent="æœªå–å¾—"; $rateTime.textContent="";
    fetchRate();
  });
  // åˆæœŸ
  paintSaved();

  /* ========= ãƒãƒ£ãƒ¼ãƒˆ ========= */
  const currencies = [
    {code:"USD", flag:"ğŸ‡ºğŸ‡¸", country:"ã‚¢ãƒ¡ãƒªã‚«", name:"ç±³ãƒ‰ãƒ«"},
    {code:"JPY", flag:"ğŸ‡¯ğŸ‡µ", country:"æ—¥æœ¬",     name:"æ—¥æœ¬å††"},
    {code:"EUR", flag:"ğŸ‡ªğŸ‡º", country:"æ¬§å·é€£åˆ", name:"ãƒ¦ãƒ¼ãƒ­"},
    {code:"GBP", flag:"ğŸ‡¬ğŸ‡§", country:"ã‚¤ã‚®ãƒªã‚¹", name:"è‹±ãƒãƒ³ãƒ‰"},
    {code:"AUD", flag:"ğŸ‡¦ğŸ‡º", country:"ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢", name:"è±ªãƒ‰ãƒ«"},
    {code:"CAD", flag:"ğŸ‡¨ğŸ‡¦", country:"ã‚«ãƒŠãƒ€",   name:"ã‚«ãƒŠãƒ€ãƒ‰ãƒ«"},
    {code:"CHF", flag:"ğŸ‡¨ğŸ‡­", country:"ã‚¹ã‚¤ã‚¹",   name:"ã‚¹ã‚¤ã‚¹ãƒ•ãƒ©ãƒ³"},
    {code:"HKD", flag:"ğŸ‡­ğŸ‡°", country:"é¦™æ¸¯",     name:"é¦™æ¸¯ãƒ‰ãƒ«"},
    {code:"CNY", flag:"ğŸ‡¨ğŸ‡³", country:"ä¸­å›½",     name:"äººæ°‘å…ƒ"},
    {code:"KRW", flag:"ğŸ‡°ğŸ‡·", country:"éŸ“å›½",     name:"éŸ“å›½ã‚¦ã‚©ãƒ³"},
    {code:"BTC", flag:"â‚¿",   country:"æš—å·è³‡ç”£", name:"ãƒ“ãƒƒãƒˆã‚³ã‚¤ãƒ³"},
    {code:"XAU", flag:"ğŸ¥‡",   country:"è²´é‡‘å±",   name:"ã‚´ãƒ¼ãƒ«ãƒ‰ï¼ˆé‡‘ï¼‰"}
  ];
  const $base  = document.getElementById('base');
  const $quote = document.getElementById('quote');
  currencies.forEach(c=>{ $base.append(new Option(c.code,c.code)); $quote.append(new Option(c.code,c.code)); });
  $base.value="USD"; $quote.value="JPY";

  function renderChart(){
    if ($base.value===$quote.value) return;
    let symbol;
    if ($base.value==="BTC" || $quote.value==="BTC"){
      symbol="BINANCE:BTCUSDT"; // BTCã¯USDå»ºã¦å›ºå®š
    } else if ($base.value==="XAU" || $quote.value==="XAU"){
      symbol="TVC:GOLD";        // GOLDã¯ãƒ‰ãƒ«å»ºã¦å›ºå®š
    } else {
      symbol=`FX_IDC:${$base.value}${$quote.value}`;
    }
    document.getElementById('tvchart').innerHTML="";
    new TradingView.widget({
      container_id:"tvchart",
      symbol, interval:"60", width:"100%", height:440, locale:"ja", theme:"light"
    });
  }
  document.getElementById('btnSwap').addEventListener('click', ()=>{
    const t=$base.value; $base.value=$quote.value; $quote.value=t; renderChart();
  });
  $base.addEventListener('change', renderChart);
  $quote.addEventListener('change', renderChart);
  renderChart();

  /* ========= é€šè²¨ã‚³ãƒ¼ãƒ‰ä¸€è¦§ ========= */
  document.getElementById('codeList').innerHTML = currencies.map(c=>`
    <div class="item">
      <span class="flag">${c.flag}</span>
      <b class="code">${c.code}</b>
      <div>
        <div>${c.country}</div>
        <div class="muted">${c.name}</div>
      </div>
    </div>
  `).join("");
</script>
</html>
